{% extends 'base.html' %}
{% block content %}
<style>
body {
    background-color: #f3f4f6;
    font-family: 'Segoe UI', sans-serif;
}
</style>

<h1>Post: {{ post.title }}</h1>
<p class="text-muted">
    Blog: {{ post.blog.title }} — Autor: {{ post.author }} — {{ post.created_at }}
</p>

<div class="mb-4">{{ post.content|linebreaks }}</div>

<a href="{% url 'blog_detail' post.blog.pk %}" class="btn btn-secondary">Powrót</a>

<hr>

<h4>Komentarze</h4>

{% if user.is_authenticated %}
    {% include 'comments/comment_form.html' with post=post comment_form=comment_form %}
{% else %}
    <p><a href="/accounts/login/">Zaloguj się</a>, aby dodać komentarz.</p>
{% endif %}

<hr>

<div id="comments-container">
    {% for comment in top_level_comments %}
        {% include "comments/comment.html" with comment=comment post=post %}
    {% empty %}
        <p>Brak komentarzy.</p>
    {% endfor %}
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener("DOMContentLoaded", () => {
    const csrftoken = getCookie('csrftoken');

    function handleFormSubmit(form, parentId = null) {
        form.addEventListener("submit", e => {
            e.preventDefault();
            const formData = new FormData(form);

            fetch(form.action, {
                method: "POST",
                headers: {
                    "X-CSRFToken": csrftoken,
                    "X-Requested-With": "XMLHttpRequest"
                },
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (parentId) {
                    const container = document.querySelector(`#comment-${parentId} .ms-4`);
                    container.insertAdjacentHTML("beforeend", data.html);
                } else {
                    const list = document.querySelector("#comments-container");
                    list.insertAdjacentHTML("afterbegin", data.html);
                }

                form.reset();
                attachReplyForms(); 
            });
        });
    }

    function attachReplyForms() {
        document.querySelectorAll(".reply-form").forEach(form => {
            if (!form.dataset.bound) {
                const parentId = form.querySelector("[name='parent_id']").value;
                handleFormSubmit(form, parentId);
                form.dataset.bound = "true";
            }
        });
    }

    document.querySelectorAll(".comment-form").forEach(form => handleFormSubmit(form));
    attachReplyForms();
});
</script>

{% endblock %}

